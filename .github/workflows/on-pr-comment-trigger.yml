name: Check new comment for commands

on:
  issue_comment:
    types: [created, edited]

env:
  TARGET_CHERRY_PICK_BRANCH: cherry-pick-base
  BASE_BRANCH: master

jobs:
  setup_env:
    # This job only runs for pull request comments
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      # Store the branch name in an environment variable called BRANCH_NAME
      - name: set env
        id: setup
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const curPRNumber = parseInt(context.payload.issue.pull_request.url.split('/').pop());
            const curPR = await github.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: curPRNumber
            });

            const branchName = curPR.data.head.ref;
            const prUrl = curPR.data.html_url;

            console.info("Working on branch", branchName);
            core.setOutput('BRANCH_NAME', branchName);
            core.setOutput('PR_URL', prUrl);
    outputs:
      BRANCH_NAME: ${{ steps.setup.outputs.BRANCH_NAME }}
      PR_URL: ${{ steps.setup.outputs.PR_URL }}

  notify-start:
    needs: [setup_env]
    # This job only runs for pull request comments
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: notify command
        uses: actions/github-script@v3
        with:
          script: |
            const commentBody = context.payload.comment.body;
            const commandToRunList = [];
            if (commentBody.includes('command--joke')) {
              commandToRunList.push('joke');
            }
            if (commentBody.includes('command--random-sum')) {
              commandToRunList.push('random-sum');
            }
            if (commentBody.includes('command--cherry-pick')) {
              commandToRunList.push('cherry-pick');
            }

            if (commandToRunList.length === 0) {
              return;
            }

            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const commentType = "Running command";
            const body = `
              **${commentType}** üß™ Starting...
              ${commandToRunList.map(command => `- ${command}`).join('\n')}
            `
            const comment = await github.issues.createComment({
              issue_number,
              owner,
              repo,
              body
            });

  run_commands:
    # This job only runs for pull request comments
    if: ${{ github.event.issue.pull_request }}
    needs: [setup_env, notify-start]
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ needs.setup_env.outputs.BRANCH_NAME }}
      PR_URL: ${{ needs.setup_env.outputs.PR_URL }}
    steps:
      - uses: actions/checkout@v2

      - name: run joke
        if: contains(github.event.comment.body, 'command--joke')
        run: npm run joke

      - name: run random sum
        if: contains(github.event.comment.body, 'command--random-sum')
        run: npm run random-sum

      - name: cherry-pick
        if: contains(github.event.comment.body, 'command--cherry-pick')
        # Cherry pick all the commits in the current branch to a new branch named `<cur-branch-name>--cherry-pick` `cherry-pick` branch
        # All the commits are taken from the current branch
        run: |
          echo "BRANCH_NAME=${BRANCH_NAME}" &&
          echo "TARGET_CHERRY_PICK_BRANCH=${TARGET_CHERRY_PICK_BRANCH}" &&
          echo "BASE_BRANCH=${BASE_BRANCH}" &&

          git fetch origin $BASE_BRANCH &&
          git fetch origin $BRANCH_NAME &&
          git checkout $BRANCH_NAME &&

          echo "Start commit: $(git merge-base $BASE_BRANCH $BRANCH_NAME)" &&

          git fetch origin $TARGET_CHERRY_PICK_BRANCH &&
          git checkout $TARGET_CHERRY_PICK_BRANCH &&

          new_branch_name="${BRANCH_NAME}--cherry-pick" &&
          git checkout -b $new_branch_name &&
          echo "New branch name: $new_branch_name" &&


          echo "Setting up git user for cherry-pick" &&
          git config user.name "Commit bot" &&
          git config user.email "no-email@no-email" &&

          echo "Cherry picking from commit $(git merge-base $BASE_BRANCH $BRANCH_NAME) to commit $BRANCH_NAME" &&
          git cherry-pick $(git merge-base $BASE_BRANCH $BRANCH_NAME)..$BRANCH_NAME --strategy=recursive --strategy-option=theirs &&
          git push origin $new_branch_name

      - name: cherry-pick pr creation
        if: contains(github.event.comment.body, 'command--cherry-pick')
        uses: actions/github-script@v3
        with:
          script: |
            const { BRANCH_NAME: prBranchName, TARGET_CHERRY_PICK_BRANCH: targetBranch, PR_URL: mainPRUrl } = process.env;

            const newBranchName = `${prBranchName}--cherry-pick`
            const commentBody = context.payload.comment.body;
            const prTitle = `chore: cherry pick ${prBranchName} üçí‚õè`;
            const prBody = `
              This PR is created to cherry pick üçí‚õè all the commits from \`${prBranchName}\` to \`${newBranchName}\`.
              Main PR can be found [here](${mainPRUrl})
            `;
            const pr = await github.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: prTitle,
              head: newBranchName,
              base: targetBranch,
              body: prBody
            });
            const commentType = "Cherry picking PR";
            const body = `
            **${commentType}** ‚úÖ Done!
            You can checkout the run result at [PR](${pr.data.html_url})
            `;
            const comment = await github.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      # Intentionally create a new comment to trigger notification
      #   since test can take a long time to run
      - name: report error
        # Run when any of the command fails
        if: always() && failure()
        uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const baseUrl = context.payload.repository.html_url;

            const commentType = "Running command";
            const body = `
            **${commentType}** üö´ Failed
            You can checkout the run result at [Actions](${baseUrl}/actions/runs/${runId})
            `;
            const comment = await github.issues.createComment({
              issue_number,
              owner,
              repo,
              body
            });

  notify_end:
    needs: [run_commands]
    # This job only runs for pull request comments
    if: ${{ github.event.issue.pull_request }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: notify done
        uses: actions/github-script@v3
        with:
          script: |
            const commentBody = context.payload.comment.body;
            const commandToRunList = [];
            if (commentBody.includes('command--joke')) {
              commandToRunList.push('joke');
            }
            if (commentBody.includes('command--random-sum')) {
              commandToRunList.push('random-sum');
            }
            if (commentBody.includes('command--cherry-pick')) {
              commandToRunList.push('cherry-pick');
            }

            if (commandToRunList.length === 0) {
              return;
            }

            const issue_number = context.issue.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const runId = context.runId;
            const baseUrl = context.payload.repository.html_url;

            const commentType = "Running command";
            const body = `
            **${commentType}** ‚úÖ Done!
            You can checkout the run result at [Actions](${baseUrl}/actions/runs/${runId})
            `;
            const comment = await github.issues.createComment({
              issue_number,
              owner,
              repo,
              body
            });
